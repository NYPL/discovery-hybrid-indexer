# Discovery Hybrid Indexer

This is an experimental app investigating combining the [DiscoveryStorePoster](https://github.com/NYPL-discovery/discovery-store-poster) and [DiscoveryApiIndexer](https://github.com/NYPL-discovery/discovery-api-indexer) deployments into a single app that accomplishes their work without the overhead of an intermediary database (the "legacy discovery-store database"). This implementation includes both components as modules, overwriting certain behaviors (notably db writes and reads). It may be connected to the same Lambda triggers currently used in the [DiscoveryStorePoster](https://github.com/NYPL-discovery/discovery-store-poster) and can be expected to produce the same output as the [DiscoveryApiIndexer](https://github.com/NYPL-discovery/discovery-api-indexer).

## Setup

```
nvm use; npm i
```

You can then process event files like so:

```
$ sam local invoke --profile nypl-digital-dev -t sam.qa.yml -e test/sample-events/b10128427.json
Invoking index.handler (nodejs10.x)
...
{"timestamp":"2021-07-15T14:12:35.095Z","levelCode":6,"level":"INFO","pid":"14","message":"Handling Bib event: sierra-nypl/10128427"}
{"timestamp":"2021-07-15T14:12:39.775Z","levelCode":6,"level":"INFO","pid":"14","message":"Completed processing 1 doc(s)"}
END RequestId: 79eeb9f0-2c7c-45ae-8322-ace4ee89bfed
REPORT RequestId: 79eeb9f0-2c7c-45ae-8322-ace4ee89bfed	Init Duration: 0.12 ms	Duration: 12696.30 ms	Billed Duration: 12700 ms	Memory Size: 128 MB	Max Memory Used: 128 MB
"Wrote 1 doc(s)"%
```

## Testing

To run several tests of this app's ability to handle various Kinesis events and write relevant ES documents:

```
nvm use
npm test
```

### Sample Events

`test/sample-events` contains a number of JSONs modeling Bib, Item, and Holding Kinesis stream events.

#### Comparing with remote indexed document

Compare ES document generated by this app with the document currently indexed remotely via:
```
node scripts/compare-with-indexed.js ./test/sample-events/b10128427.json [--envfile config/qa.env]
```

#### Creating sample events
To create a new sample event, use the `kinesify-data` script from `discovery-store-poster`, e.g.:

```
node ./node_modules/pcdm-store-updater/kinesify-data.js --profile nypl-digital-dev --envfile config/local-qa.env --ids 10128427 --nyplType bib '' test/sample-events/b10128427.json
```

Note you'll need to specify an `envfile` that contains these *decrypted* creds:
```
NYPL_API_BASE_URL=http://qa-platform.nypl.org/api/v0.1/
NYPL_OAUTH_URL=https://isso.nypl.org/
NYPL_OAUTH_KEY=[decrypted key]
NYPL_OAUTH_SECRET=[decrypted secret]
```

## Contributing

This repo uses the [Development-QA-Main Git Workflow](https://github.com/NYPL/engineering-general/blob/master/standards/git-workflow.md#development-qa-main)


